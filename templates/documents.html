{% extends "base.html" %}

{% block title %}Records - Assort Design{% endblock %}

{% block content %}
  <div class="card">
    <h2>Records</h2>
    <p class="muted">Browse every document routed through Assort Design.</p>
    <form method="get" action="/web/documents">
      <div class="search-bar">
        <input
          type="text"
          name="q"
          placeholder="Search content, tags, or clues"
          value="{{ query }}"
        />
        {% if domain_filter %}
          <input type="hidden" name="domain" value="{{ domain_filter }}" />
        {% endif %}
        <select name="audience">
          <option value="all" {% if selected_audience == "all" %}selected{% endif %}>
            All routes
          </option>
          {% for aud in audiences %}
            <option
              value="{{ aud }}"
              {% if selected_audience == aud %}selected{% endif %}
            >
              {{ audience_display.get(aud, aud) }}
            </option>
          {% endfor %}
        </select>
        <button class="button" type="submit">Search</button>
        {% if query or selected_audience != "all" or domain_filter %}
          <a class="button" href="/web/documents">Clear</a>
        {% endif %}
      </div>
    </form>
  </div>

  <div class="card">
    <h3>Route Filters</h3>
    <ul>
      <li>
        <a href="/web/documents{% if query or domain_filter %}?{% endif %}{% if query %}q={{ query | urlencode }}{% endif %}{% if query and domain_filter %}&{% endif %}{% if domain_filter %}domain={{ domain_filter | urlencode }}{% endif %}">
          <strong>All</strong>
          {% if selected_audience == "all" %}
            <span class="muted">(selected)</span>
          {% endif %}
        </a>
      </li>
      {% for aud in audiences %}
        <li>
          <a href="/web/documents?audience={{ aud }}{% if query %}&q={{ query | urlencode }}{% endif %}{% if domain_filter %}&domain={{ domain_filter | urlencode }}{% endif %}">
            <strong
              class="{% if audience_display.get(aud, aud) == 'Cross-Functional' %}tooltip{% endif %}"
              {% if audience_display.get(aud, aud) == 'Cross-Functional' %}
                data-tip="Mixed stakeholders (see request for details)"
              {% endif %}
            >
              {{ audience_display.get(aud, aud) }}
            </strong>:
            {{ route_counts.get(aud, 0) }}
            {% if selected_audience == aud %}
              <span class="muted">(selected)</span>
            {% endif %}
          </a>
        </li>
      {% endfor %}
    </ul>
  </div>

  {% if documents %}
    {% for doc in documents %}
      <div class="card">
        <div class="muted">
          <strong>Route:</strong>
          <span
            class="{% if audience_display.get(doc.audience, doc.audience) == 'Cross-Functional' %}tooltip{% endif %}"
            {% if audience_display.get(doc.audience, doc.audience) == 'Cross-Functional' %}
              data-tip="Mixed stakeholders (see request for details)"
            {% endif %}
          >
            {{ audience_display.get(doc.audience, doc.audience) }}
          </span>
          • <span class="status-chip status-{{ doc.status }}">{{ doc.status }}</span>
        </div>
        <p>{{ doc.snippet }}</p>
        {% if doc.summary %}
          <p><strong>One-line summary:</strong> {{ doc.summary }}</p>
        {% else %}
          <p class="muted">No summary yet.</p>
        {% endif %}
        {% if show_tool_badges and doc.tool_summary %}
          <p class="muted">
            Citations: {{ doc.tool_summary.citations }}
            &nbsp;·&nbsp; Risk: {{ doc.tool_summary.risk.high }} High / {{ doc.tool_summary.risk.medium }} Medium / {{ doc.tool_summary.risk.low }} Low
          </p>
        {% endif %}
        <div class="actions">
          {% if doc.job_id %}
            <a class="button" href="/web/jobs/{{ doc.job_id }}">View Request</a>
          {% endif %}
          <a class="button" href="/web/documents/{{ doc.document_id }}">View Source</a>
        </div>
      </div>
    {% endfor %}

    <div class="card">
      <div class="pagination">
        {% if has_prev %}
        <a class="button" href="/web/documents?page={{ page - 1 }}{% if selected_audience != "all" %}&audience={{ selected_audience }}{% endif %}{% if query %}&q={{ query | urlencode }}{% endif %}{% if domain_filter %}&domain={{ domain_filter | urlencode }}{% endif %}">Previous</a>
        {% endif %}
        <span class="muted">Page {{ page }}</span>
        {% if has_next %}
        <a class="button" href="/web/documents?page={{ page + 1 }}{% if selected_audience != "all" %}&audience={{ selected_audience }}{% endif %}{% if query %}&q={{ query | urlencode }}{% endif %}{% if domain_filter %}&domain={{ domain_filter | urlencode }}{% endif %}">Next</a>
        {% endif %}
      </div>
    </div>
  {% else %}
    <div class="card">
      <p class="muted">No records found for this filter.</p>
    </div>
  {% endif %}
{% endblock %}
