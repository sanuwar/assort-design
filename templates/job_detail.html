{% extends "base.html" %}

{% block title %}Job {{ job.id }} - Asort Design{% endblock %}

{% block content %}
  <div class="card">
    <h2>Request {{ job_ref }}</h2>
    <p class="muted">Audience: {{ audience_label }} • Status: {{ job.status }}</p>
  </div>

  <div class="row">
    <div class="card">
      <h3>Analyze Now</h3>
      <p class="muted">Runs the pipeline and returns outputs in this order:</p>
      <ul>
        <li>One-line summary</li>
        <li>Decision bullets (3–5)</li>
        <li>Tags</li>
        <li>Key clues</li>
        <li>Mind map</li>
      </ul>
      <div class="actions">
        <form method="post" action="/web/jobs/{{ job.id }}/run">
          <button class="button" type="submit">Analyze Now</button>
        </form>
      </div>
    </div>
    <div class="card">
      <h3>View Source</h3>
      <p class="muted">Open the original document text used for analysis.</p>
      <div class="actions">
        {% if document %}
          <a class="button" href="/web/documents/{{ document.id }}">View Source</a>
        {% else %}
          <span class="muted">No document linked.</span>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card">
    <details>
      <summary>Metadata (Attempts &amp; Trace Legend)</summary>
      <h4>Attempts</h4>
      {% if attempts %}
        <ul>
          {% for attempt in attempts %}
            <li>
              Attempt {{ attempt.attempt_no }} —
              {% if attempt.passed %}
                Passed
              {% else %}
                Failed
              {% endif %}
              <div class="muted">{{ attempt.summary_preview }}</div>
              {% if not attempt.passed and attempt.fail_reasons %}
                <div class="muted">Fail reasons: {{ attempt.fail_reasons | join(", ") }}</div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No attempts yet.</p>
      {% endif %}

      <h4>Trace Legend</h4>
      <ul class="legend-list">
        <li><strong>Route Audience</strong>: Classifies the document into an audience.</li>
        <li><strong>Specialist Generate</strong>: Produces one-line summary, key clues, decision bullets, mind map, and tags.</li>
        <li><strong>Evaluate</strong>: Checks required sections, word count, and 3–5 bullet constraint.</li>
        <li><strong>Persist Attempt</strong>: Saves the attempt record.</li>
        <li><strong>Next Step</strong>: Decides whether to revise or persist results.</li>
        <li><strong>Persist Results</strong>: Saves final clues and tags at the document level.</li>
      </ul>
    </details>
  </div>

  <div class="card">
    <h3>One-line Summary</h3>
    {% if final_summary and final_summary.one_line_summary %}
      <p>{{ final_summary.one_line_summary }}</p>
    {% else %}
      <p class="muted">No accepted summary yet.</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>Decision Bullets</h3>
    <p class="muted">Expected: 3–5 bullets.</p>
    <div class="toggle-row">
      <label>
        <input
          type="checkbox"
          checked
          onclick="document.getElementById('bullets-section').classList.toggle('hidden', !this.checked)"
        />
        Show bullets
      </label>
      <label>
        <input
          type="checkbox"
          onclick="toggleMindMap('mindmap-section', this.checked)"
        />
        Show mind map
      </label>
    </div>
    {% if final_summary and final_summary.decision_bullets %}
      <div id="bullets-section">
        <ul>
          {% for bullet in final_summary.decision_bullets %}
            <li>{{ bullet }}</li>
          {% endfor %}
        </ul>
      </div>
    {% else %}
      <div id="bullets-section">
        <p class="muted">No decision bullets yet.</p>
      </div>
    {% endif %}
  </div>

  <div class="card">
    <h3>Mind Map</h3>
    {% if final_summary and final_summary.mind_map %}
      <div id="mindmap-section" class="hidden">
        <pre class="mermaid">{{ final_summary.mind_map }}</pre>
        <p class="muted">If the diagram doesn't render, ensure Mermaid is available.</p>
      </div>
    {% else %}
      <div id="mindmap-section" class="hidden">
        <p class="muted">No mind map yet.</p>
      </div>
    {% endif %}
  </div>

  <div class="card">
    <h3>Tags</h3>
    {% if tags %}
      <ul>
        {% for tag in tags %}
          <li>{{ tag.name }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">No tags yet.</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>Key Clues</h3>
    {% if clues %}
      <ul>
        {% for clue in clues %}
          <li>{{ clue.clue_text }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">No clues yet.</p>
    {% endif %}
  </div>
{% endblock %}
