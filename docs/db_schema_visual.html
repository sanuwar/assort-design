<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Database Schema – Asort Design</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 14px;
      color: #1a1a2e;
      background: #ffffff;
      padding: 40px 60px;
      max-width: 1100px;
      margin: 0 auto;
    }

    h1 {
      font-size: 26px;
      font-weight: 700;
      color: #0f3460;
      border-bottom: 3px solid #0f3460;
      padding-bottom: 10px;
      margin-bottom: 32px;
    }

    h2 {
      font-size: 18px;
      font-weight: 600;
      color: #16213e;
      margin: 36px 0 16px 0;
      padding-left: 10px;
      border-left: 4px solid #e94560;
    }

    .diagram-box {
      background: #f8f9fc;
      border: 1px solid #dde2ee;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 8px;
      overflow-x: auto;
      display: flex;
      justify-content: center;
    }

    .diagram-box .mermaid {
      min-width: 600px;
    }

    pre {
      background: #1e1e2e;
      color: #cdd6f4;
      font-family: "Cascadia Code", "Fira Code", "Consolas", monospace;
      font-size: 12.5px;
      line-height: 1.6;
      border-radius: 8px;
      padding: 20px 24px;
      overflow-x: auto;
      margin-bottom: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 8px;
      font-size: 13px;
    }

    thead tr {
      background: #0f3460;
      color: #ffffff;
    }

    th, td {
      padding: 9px 14px;
      text-align: left;
      border: 1px solid #dde2ee;
    }

    tbody tr:nth-child(even) { background: #f3f5fb; }
    tbody tr:hover            { background: #e8edf8; }

    code {
      font-family: "Cascadia Code", "Fira Code", "Consolas", monospace;
      background: #eef0f8;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      color: #e94560;
    }

    hr {
      border: none;
      border-top: 1px solid #dde2ee;
      margin: 40px 0;
    }

    .caption {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
      margin-bottom: 24px;
      padding-left: 4px;
    }

    @media print {
      body { padding: 20px 30px; }
      .diagram-box { break-inside: avoid; page-break-inside: avoid; }
      pre { break-inside: avoid; page-break-inside: avoid; }
      table { break-inside: avoid; page-break-inside: avoid; }
    }
  </style>
</head>
<body>

  <h1>Database Schema &mdash; Asort Design</h1>

  <!-- ── ER DIAGRAM ───────────────────────────────────────────── -->
  <h2>Entity Relationship Diagram</h2>
  <div class="diagram-box">
    <div class="mermaid">
erDiagram
    Document {
        int      id           PK
        text     content
        text     source_type
        datetime created_at
    }

    Job {
        int      id                       PK
        int      document_id              FK
        text     selected_audience
        text     audience
        float    routing_confidence
        text     routing_candidates_json
        text     routing_reasons_json
        text     status
        int      attempt_count
        int      max_words
        int      max_retries
        datetime created_at
    }

    JobAttempt {
        int      id                           PK
        int      job_id                       FK
        int      attempt_no
        text     audience
        text     agent_used
        text     generated_one_line_summary
        text     generated_tags_json
        text     generated_clues_json
        text     generated_bullets_json
        text     generated_mindmap
        text     evaluator_json
        bool     passed
        datetime created_at
    }

    Tag {
        int  id    PK
        text name
    }

    DocumentTag {
        int  document_id  PK
        int  tag_id       PK
    }

    DocumentClue {
        int      id           PK
        int      document_id  FK
        text     clue_text
        datetime created_at
    }

    Document    ||--o{ Job          : "has"
    Job         ||--o{ JobAttempt   : "has"
    Document    ||--o{ DocumentClue : "has"
    DocumentTag }o--|| Document     : ""
    DocumentTag }o--|| Tag          : ""
    </div>
  </div>
  <p class="caption">PK = Primary Key &nbsp;|&nbsp; FK = Foreign Key</p>

  <hr />

  <!-- ── TABLE TREE ────────────────────────────────────────────── -->
  <h2>Table &amp; Relationship Tree</h2>
  <pre>
Tables &amp; Relationships
│
├── Document                   Core content record
│   ├── id (PK)
│   ├── content
│   ├── source_type
│   └── created_at
│       │
│       ├──&lt; Job                One document → many jobs
│       │     ├── id (PK)
│       │     ├── document_id (FK → Document.id)  [indexed]
│       │     ├── selected_audience
│       │     ├── audience
│       │     ├── routing_confidence
│       │     ├── routing_candidates_json
│       │     ├── routing_reasons_json
│       │     ├── status
│       │     ├── attempt_count
│       │     ├── max_words
│       │     ├── max_retries
│       │     └── created_at
│       │           │
│       │           └──&lt; JobAttempt      One job → many attempts
│       │                 ├── id (PK)
│       │                 ├── job_id (FK → Job.id)  [indexed]
│       │                 ├── attempt_no
│       │                 ├── audience
│       │                 ├── agent_used
│       │                 ├── generated_one_line_summary
│       │                 ├── generated_tags_json
│       │                 ├── generated_clues_json
│       │                 ├── generated_bullets_json
│       │                 ├── generated_mindmap
│       │                 ├── evaluator_json
│       │                 ├── passed
│       │                 └── created_at
│       │
│       ├──&lt; DocumentClue       One document → many clues
│       │     ├── id (PK)
│       │     ├── document_id (FK → Document.id)  [indexed]
│       │     ├── clue_text
│       │     └── created_at
│       │
│       └──&lt; DocumentTag        Join table (many-to-many with Tag)
│             ├── document_id (PK, FK → Document.id)  [indexed]
│             └── tag_id      (PK, FK → Tag.id)       [indexed]
│
└── Tag                         Global tag registry
      ├── id (PK)
      └── name  [unique, indexed]
  </pre>
  <p class="caption">└──&lt; denotes a one-to-many relationship from parent to child</p>

  <hr />

  <!-- ── INDEXES ───────────────────────────────────────────────── -->
  <h2>Indexes</h2>
  <table>
    <thead>
      <tr>
        <th>Index Name</th>
        <th>Table</th>
        <th>Column(s)</th>
        <th>Purpose</th>
      </tr>
    </thead>
    <tbody>
      <tr><td><code>ix_job_document_id</code></td>          <td>job</td>          <td>document_id</td> <td>FK lookup — find jobs for a document</td></tr>
      <tr><td><code>ix_jobattempt_job_id</code></td>        <td>jobattempt</td>   <td>job_id</td>      <td>FK lookup — find attempts for a job</td></tr>
      <tr><td><code>ix_documentclue_document_id</code></td> <td>documentclue</td> <td>document_id</td> <td>FK lookup — find clues for a document</td></tr>
      <tr><td><code>ix_documenttag_document_id</code></td>  <td>documenttag</td>  <td>document_id</td> <td>FK lookup — find tags for a document</td></tr>
      <tr><td><code>ix_documenttag_tag_id</code></td>       <td>documenttag</td>  <td>tag_id</td>      <td>FK lookup — find documents with a tag</td></tr>
      <tr><td><em>(auto — unique)</em></td>                 <td>tag</td>          <td>name</td>        <td>Enforce uniqueness &amp; fast name lookup</td></tr>
    </tbody>
  </table>

  <hr />

  <!-- ── JOB STATUS FLOW ───────────────────────────────────────── -->
  <h2>Job Status Flow</h2>
  <div class="diagram-box">
    <div class="mermaid">
stateDiagram-v2
    [*] --> pending
    pending --> running
    running --> done
    running --> failed
    failed --> running : retry (attempt_count &lt; max_retries)
    failed --> [*]
    done --> [*]
    </div>
  </div>
  <p class="caption">Job retries up to <code>max_retries</code> (default&nbsp;2) before staying in <code>failed</code></p>

  <script>
    mermaid.initialize({ startOnLoad: true, theme: "default", er: { diagramPadding: 20 } });
  </script>
</body>
</html>
